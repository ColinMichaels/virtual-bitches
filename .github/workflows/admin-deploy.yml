name: Deploy Admin Portal

on:
  push:
    branches:
      - main
      - master
      - dev
    paths:
      - "admin/**"
      - ".github/workflows/admin-deploy.yml"
      - "docs/ADMIN-PORTAL-ANGULAR-PLAN.md"
  workflow_dispatch:
    inputs:
      deploy_admin:
        description: Build and deploy admin portal
        type: boolean
        default: true
      run_admin_smoke:
        description: Run admin hosting URL smoke probe after deploy
        type: boolean
        default: false

concurrency:
  group: deploy-admin-${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  resolve_target:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.deploy_admin }}
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'dev' && 'admin-dev' || 'admin-prod' }}
    outputs:
      project_id: ${{ steps.target.outputs.project_id }}
      firebase_config_path: ${{ steps.target.outputs.firebase_config_path }}
      dist_dir: ${{ steps.target.outputs.dist_dir }}
      hosting_target: ${{ steps.target.outputs.hosting_target }}
      app_base_url: ${{ steps.target.outputs.app_base_url }}

    steps:
      - name: Resolve Admin Deployment Target
        id: target
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          ADMIN_FIREBASE_PROJECT_ID_SECRET: ${{ secrets.ADMIN_FIREBASE_PROJECT_ID }}
          ADMIN_FIREBASE_PROJECT_ID_PROD_SECRET: ${{ secrets.ADMIN_FIREBASE_PROJECT_ID_PROD }}
          ADMIN_FIREBASE_PROJECT_ID_DEV_SECRET: ${{ secrets.ADMIN_FIREBASE_PROJECT_ID_DEV }}
          ADMIN_FIREBASE_PROJECT_ID_VAR: ${{ vars.ADMIN_FIREBASE_PROJECT_ID }}
          ADMIN_FIREBASE_PROJECT_ID_PROD_VAR: ${{ vars.ADMIN_FIREBASE_PROJECT_ID_PROD }}
          ADMIN_FIREBASE_PROJECT_ID_DEV_VAR: ${{ vars.ADMIN_FIREBASE_PROJECT_ID_DEV }}
          FIREBASE_PROJECT_ID_SECRET: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_PROJECT_ID_PROD_SECRET: ${{ secrets.FIREBASE_PROJECT_ID_PROD }}
          FIREBASE_PROJECT_ID_DEV_SECRET: ${{ secrets.FIREBASE_PROJECT_ID_DEV }}
          FIREBASE_PROJECT_ID_VAR: ${{ vars.FIREBASE_PROJECT_ID }}
          FIREBASE_PROJECT_ID_PROD_VAR: ${{ vars.FIREBASE_PROJECT_ID_PROD }}
          FIREBASE_PROJECT_ID_DEV_VAR: ${{ vars.FIREBASE_PROJECT_ID_DEV }}
          ADMIN_FIREBASE_CONFIG_PATH_VAR: ${{ vars.ADMIN_FIREBASE_CONFIG_PATH }}
          ADMIN_DIST_DIR_VAR: ${{ vars.ADMIN_DIST_DIR }}
          ADMIN_HOSTING_TARGET_VAR: ${{ vars.ADMIN_HOSTING_TARGET }}
          ADMIN_APP_BASE_URL_VAR: ${{ vars.ADMIN_APP_BASE_URL }}
          ADMIN_APP_BASE_URL_PROD_VAR: ${{ vars.ADMIN_APP_BASE_URL_PROD }}
          ADMIN_APP_BASE_URL_DEV_VAR: ${{ vars.ADMIN_APP_BASE_URL_DEV }}
        run: |
          set -euo pipefail

          resolve_value() {
            local candidate=""
            for candidate in "$@"; do
              if [ -n "${candidate:-}" ]; then
                printf '%s' "$candidate"
                return 0
              fi
            done
            printf ''
          }

          if [ "$BRANCH_NAME" = "master" ] || [ "$BRANCH_NAME" = "main" ]; then
            PROJECT_ID="$(resolve_value "$ADMIN_FIREBASE_PROJECT_ID_PROD_SECRET" "$ADMIN_FIREBASE_PROJECT_ID_SECRET" "$ADMIN_FIREBASE_PROJECT_ID_PROD_VAR" "$ADMIN_FIREBASE_PROJECT_ID_VAR" "$FIREBASE_PROJECT_ID_PROD_SECRET" "$FIREBASE_PROJECT_ID_SECRET" "$FIREBASE_PROJECT_ID_PROD_VAR" "$FIREBASE_PROJECT_ID_VAR")"
            APP_BASE_URL="$(resolve_value "$ADMIN_APP_BASE_URL_PROD_VAR" "$ADMIN_APP_BASE_URL_VAR")"
          elif [ "$BRANCH_NAME" = "dev" ]; then
            PROJECT_ID="$(resolve_value "$ADMIN_FIREBASE_PROJECT_ID_DEV_SECRET" "$ADMIN_FIREBASE_PROJECT_ID_SECRET" "$ADMIN_FIREBASE_PROJECT_ID_DEV_VAR" "$ADMIN_FIREBASE_PROJECT_ID_VAR" "$FIREBASE_PROJECT_ID_DEV_SECRET" "$FIREBASE_PROJECT_ID_SECRET" "$FIREBASE_PROJECT_ID_DEV_VAR" "$FIREBASE_PROJECT_ID_VAR")"
            APP_BASE_URL="$(resolve_value "$ADMIN_APP_BASE_URL_DEV_VAR" "$ADMIN_APP_BASE_URL_VAR")"
          else
            echo "Unsupported branch: $BRANCH_NAME"
            exit 1
          fi

          if [ -z "${PROJECT_ID:-}" ]; then
            echo "Missing admin Firebase project ID. Configure ADMIN_FIREBASE_PROJECT_ID(_DEV/_PROD) in vars/secrets."
            exit 1
          fi

          FIREBASE_CONFIG_PATH="$(resolve_value "$ADMIN_FIREBASE_CONFIG_PATH_VAR" "admin/firebase.json")"
          DIST_DIR="$(resolve_value "$ADMIN_DIST_DIR_VAR" "admin/dist")"
          HOSTING_TARGET="$(resolve_value "$ADMIN_HOSTING_TARGET_VAR")"

          echo "project_id=$PROJECT_ID" >> "$GITHUB_OUTPUT"
          echo "firebase_config_path=$FIREBASE_CONFIG_PATH" >> "$GITHUB_OUTPUT"
          echo "dist_dir=$DIST_DIR" >> "$GITHUB_OUTPUT"
          echo "hosting_target=$HOSTING_TARGET" >> "$GITHUB_OUTPUT"
          echo "app_base_url=$APP_BASE_URL" >> "$GITHUB_OUTPUT"

  deploy_admin:
    needs: resolve_target
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.deploy_admin }}
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'dev' && 'admin-dev' || 'admin-prod' }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect admin workspace
        id: detect
        run: |
          set -euo pipefail
          if [ -f "admin/package.json" ]; then
            echo "exists=1" >> "$GITHUB_OUTPUT"
          else
            echo "exists=0" >> "$GITHUB_OUTPUT"
            echo "Admin workspace not found at admin/package.json; skipping admin deploy."
          fi

      - name: Setup Node
        if: ${{ steps.detect.outputs.exists == '1' }}
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Normalize Google credentials
        if: ${{ steps.detect.outputs.exists == '1' }}
        id: gcp-creds
        env:
          ADMIN_GCP_SA_KEY: ${{ secrets.ADMIN_GCP_SA_KEY }}
          ADMIN_GCP_SA_KEY_B64: ${{ secrets.ADMIN_GCP_SA_KEY_B64 }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_SA_KEY_B64: ${{ secrets.GCP_SA_KEY_B64 }}
        run: |
          set -euo pipefail

          RAW="${ADMIN_GCP_SA_KEY:-}"
          if [ -z "$RAW" ]; then
            RAW="${ADMIN_GCP_SA_KEY_B64:-}"
          fi
          if [ -z "$RAW" ]; then
            RAW="${GCP_SA_KEY:-}"
          fi
          if [ -z "$RAW" ]; then
            RAW="${GCP_SA_KEY_B64:-}"
          fi

          if [ -z "$RAW" ]; then
            echo "Missing admin service account key. Configure ADMIN_GCP_SA_KEY or ADMIN_GCP_SA_KEY_B64."
            exit 1
          fi

          if printf '%s' "$RAW" | jq -e . >/dev/null 2>&1; then
            CREDENTIALS_JSON="$RAW"
          else
            DECODED="$(printf '%s' "$RAW" | base64 --decode 2>/dev/null || true)"
            if [ -z "$DECODED" ]; then
              DECODED="$(printf '%s' "$RAW" | base64 -d 2>/dev/null || true)"
            fi
            if [ -z "$DECODED" ] || ! printf '%s' "$DECODED" | jq -e . >/dev/null 2>&1; then
              echo "Admin service account key is not valid JSON."
              exit 1
            fi
            CREDENTIALS_JSON="$DECODED"
          fi

          if ! printf '%s' "$CREDENTIALS_JSON" | jq -e '.type == "service_account" and (.client_email|type=="string") and (.private_key|type=="string")' >/dev/null 2>&1; then
            echo "Admin credentials JSON is missing required service account fields."
            exit 1
          fi

          {
            echo "credentials_json<<EOF"
            printf '%s\n' "$CREDENTIALS_JSON"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Authenticate to Google Cloud
        if: ${{ steps.detect.outputs.exists == '1' }}
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ steps.gcp-creds.outputs.credentials_json }}
          project_id: ${{ needs.resolve_target.outputs.project_id }}

      - name: Install admin dependencies
        if: ${{ steps.detect.outputs.exists == '1' }}
        run: npm --prefix admin ci

      - name: Build admin app
        if: ${{ steps.detect.outputs.exists == '1' }}
        run: npm --prefix admin run build

      - name: Validate admin deploy paths
        if: ${{ steps.detect.outputs.exists == '1' }}
        env:
          FIREBASE_CONFIG_PATH: ${{ needs.resolve_target.outputs.firebase_config_path }}
          DIST_DIR: ${{ needs.resolve_target.outputs.dist_dir }}
        run: |
          set -euo pipefail
          if [ ! -f "$FIREBASE_CONFIG_PATH" ]; then
            echo "Missing Firebase config at $FIREBASE_CONFIG_PATH"
            exit 1
          fi
          if [ ! -d "$DIST_DIR" ]; then
            echo "Missing admin dist directory at $DIST_DIR"
            find admin -maxdepth 4 -type d | sort
            exit 1
          fi

      - name: Deploy Admin Hosting
        if: ${{ steps.detect.outputs.exists == '1' }}
        env:
          PROJECT_ID: ${{ needs.resolve_target.outputs.project_id }}
          FIREBASE_CONFIG_PATH: ${{ needs.resolve_target.outputs.firebase_config_path }}
          HOSTING_TARGET: ${{ needs.resolve_target.outputs.hosting_target }}
        run: |
          set -euo pipefail
          ONLY_ARG="hosting"
          if [ -n "${HOSTING_TARGET:-}" ]; then
            ONLY_ARG="hosting:${HOSTING_TARGET}"
          fi
          npx firebase-tools deploy --project "$PROJECT_ID" --config "$FIREBASE_CONFIG_PATH" --only "$ONLY_ARG" --non-interactive

      - name: Admin Hosting Smoke Probe
        if: ${{ steps.detect.outputs.exists == '1' && github.event_name == 'workflow_dispatch' && inputs.run_admin_smoke }}
        env:
          ADMIN_APP_BASE_URL: ${{ needs.resolve_target.outputs.app_base_url }}
        run: |
          set -euo pipefail
          if [ -z "${ADMIN_APP_BASE_URL:-}" ]; then
            echo "Skipping admin smoke probe (ADMIN_APP_BASE_URL not configured)."
            exit 0
          fi
          case "$ADMIN_APP_BASE_URL" in
            http://*|https://*)
              ;;
            *)
              echo "Skipping admin smoke probe (ADMIN_APP_BASE_URL is not absolute)."
              exit 0
              ;;
          esac
          curl --fail --silent --show-error --location --max-time 20 "$ADMIN_APP_BASE_URL" >/dev/null
          echo "Admin smoke probe passed: $ADMIN_APP_BASE_URL"

name: Deploy Firebase + Cloud Run

on:
  push:
    branches:
      - main
      - master
      - dev
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Resolve Deployment Target
        id: target
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          FIREBASE_PROJECT_ID_PROD_SECRET: ${{ secrets.FIREBASE_PROJECT_ID_PROD }}
          FIREBASE_PROJECT_ID_DEV_SECRET: ${{ secrets.FIREBASE_PROJECT_ID_DEV }}
          VITE_API_BASE_URL_PROD_SECRET: ${{ secrets.VITE_API_BASE_URL_PROD }}
          VITE_API_BASE_URL_DEV_SECRET: ${{ secrets.VITE_API_BASE_URL_DEV }}
          VITE_WS_URL_PROD_SECRET: ${{ secrets.VITE_WS_URL_PROD }}
          VITE_WS_URL_DEV_SECRET: ${{ secrets.VITE_WS_URL_DEV }}
          VITE_FIREBASE_API_KEY_PROD_SECRET: ${{ secrets.VITE_FIREBASE_API_KEY_PROD }}
          VITE_FIREBASE_API_KEY_DEV_SECRET: ${{ secrets.VITE_FIREBASE_API_KEY_DEV }}
          VITE_FIREBASE_AUTH_DOMAIN_PROD_SECRET: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN_PROD }}
          VITE_FIREBASE_AUTH_DOMAIN_DEV_SECRET: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN_DEV }}
          VITE_FIREBASE_PROJECT_ID_PROD_SECRET: ${{ secrets.VITE_FIREBASE_PROJECT_ID_PROD }}
          VITE_FIREBASE_PROJECT_ID_DEV_SECRET: ${{ secrets.VITE_FIREBASE_PROJECT_ID_DEV }}
          VITE_FIREBASE_STORAGE_BUCKET_PROD_SECRET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET_PROD }}
          VITE_FIREBASE_STORAGE_BUCKET_DEV_SECRET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET_DEV }}
          VITE_FIREBASE_MESSAGING_SENDER_ID_PROD_SECRET: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID_PROD }}
          VITE_FIREBASE_MESSAGING_SENDER_ID_DEV_SECRET: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID_DEV }}
          VITE_FIREBASE_APP_ID_PROD_SECRET: ${{ secrets.VITE_FIREBASE_APP_ID_PROD }}
          VITE_FIREBASE_APP_ID_DEV_SECRET: ${{ secrets.VITE_FIREBASE_APP_ID_DEV }}
          VITE_FIREBASE_MEASUREMENT_ID_PROD_SECRET: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID_PROD }}
          VITE_FIREBASE_MEASUREMENT_ID_DEV_SECRET: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID_DEV }}
          FIREBASE_PROJECT_ID_PROD_VAR: ${{ vars.FIREBASE_PROJECT_ID_PROD }}
          FIREBASE_PROJECT_ID_DEV_VAR: ${{ vars.FIREBASE_PROJECT_ID_DEV }}
          VITE_API_BASE_URL_PROD_VAR: ${{ vars.VITE_API_BASE_URL_PROD }}
          VITE_API_BASE_URL_DEV_VAR: ${{ vars.VITE_API_BASE_URL_DEV }}
          VITE_WS_URL_PROD_VAR: ${{ vars.VITE_WS_URL_PROD }}
          VITE_WS_URL_DEV_VAR: ${{ vars.VITE_WS_URL_DEV }}
          VITE_FIREBASE_API_KEY_PROD_VAR: ${{ vars.VITE_FIREBASE_API_KEY_PROD }}
          VITE_FIREBASE_API_KEY_DEV_VAR: ${{ vars.VITE_FIREBASE_API_KEY_DEV }}
          VITE_FIREBASE_AUTH_DOMAIN_PROD_VAR: ${{ vars.VITE_FIREBASE_AUTH_DOMAIN_PROD }}
          VITE_FIREBASE_AUTH_DOMAIN_DEV_VAR: ${{ vars.VITE_FIREBASE_AUTH_DOMAIN_DEV }}
          VITE_FIREBASE_PROJECT_ID_PROD_VAR: ${{ vars.VITE_FIREBASE_PROJECT_ID_PROD }}
          VITE_FIREBASE_PROJECT_ID_DEV_VAR: ${{ vars.VITE_FIREBASE_PROJECT_ID_DEV }}
          VITE_FIREBASE_STORAGE_BUCKET_PROD_VAR: ${{ vars.VITE_FIREBASE_STORAGE_BUCKET_PROD }}
          VITE_FIREBASE_STORAGE_BUCKET_DEV_VAR: ${{ vars.VITE_FIREBASE_STORAGE_BUCKET_DEV }}
          VITE_FIREBASE_MESSAGING_SENDER_ID_PROD_VAR: ${{ vars.VITE_FIREBASE_MESSAGING_SENDER_ID_PROD }}
          VITE_FIREBASE_MESSAGING_SENDER_ID_DEV_VAR: ${{ vars.VITE_FIREBASE_MESSAGING_SENDER_ID_DEV }}
          VITE_FIREBASE_APP_ID_PROD_VAR: ${{ vars.VITE_FIREBASE_APP_ID_PROD }}
          VITE_FIREBASE_APP_ID_DEV_VAR: ${{ vars.VITE_FIREBASE_APP_ID_DEV }}
          VITE_FIREBASE_MEASUREMENT_ID_PROD_VAR: ${{ vars.VITE_FIREBASE_MEASUREMENT_ID_PROD }}
          VITE_FIREBASE_MEASUREMENT_ID_DEV_VAR: ${{ vars.VITE_FIREBASE_MEASUREMENT_ID_DEV }}
        run: |
          set -euo pipefail

          resolve_value() {
            local from_secret="$1"
            local from_var="$2"
            if [ -n "$from_secret" ]; then
              printf '%s' "$from_secret"
            else
              printf '%s' "$from_var"
            fi
          }

          if [ "$BRANCH_NAME" = "master" ] || [ "$BRANCH_NAME" = "main" ]; then
            PROJECT_ID="$(resolve_value "$FIREBASE_PROJECT_ID_PROD_SECRET" "$FIREBASE_PROJECT_ID_PROD_VAR")"
            if [ -z "$PROJECT_ID" ]; then
              PROJECT_ID="$(resolve_value "$VITE_FIREBASE_PROJECT_ID_PROD_SECRET" "$VITE_FIREBASE_PROJECT_ID_PROD_VAR")"
            fi
            API_BASE_URL="$(resolve_value "$VITE_API_BASE_URL_PROD_SECRET" "$VITE_API_BASE_URL_PROD_VAR")"
            WS_URL="$(resolve_value "$VITE_WS_URL_PROD_SECRET" "$VITE_WS_URL_PROD_VAR")"
            FB_API_KEY="$(resolve_value "$VITE_FIREBASE_API_KEY_PROD_SECRET" "$VITE_FIREBASE_API_KEY_PROD_VAR")"
            FB_AUTH_DOMAIN="$(resolve_value "$VITE_FIREBASE_AUTH_DOMAIN_PROD_SECRET" "$VITE_FIREBASE_AUTH_DOMAIN_PROD_VAR")"
            FB_PROJECT_ID="$(resolve_value "$VITE_FIREBASE_PROJECT_ID_PROD_SECRET" "$VITE_FIREBASE_PROJECT_ID_PROD_VAR")"
            FB_STORAGE_BUCKET="$(resolve_value "$VITE_FIREBASE_STORAGE_BUCKET_PROD_SECRET" "$VITE_FIREBASE_STORAGE_BUCKET_PROD_VAR")"
            FB_SENDER_ID="$(resolve_value "$VITE_FIREBASE_MESSAGING_SENDER_ID_PROD_SECRET" "$VITE_FIREBASE_MESSAGING_SENDER_ID_PROD_VAR")"
            FB_APP_ID="$(resolve_value "$VITE_FIREBASE_APP_ID_PROD_SECRET" "$VITE_FIREBASE_APP_ID_PROD_VAR")"
            FB_MEASUREMENT_ID="$(resolve_value "$VITE_FIREBASE_MEASUREMENT_ID_PROD_SECRET" "$VITE_FIREBASE_MEASUREMENT_ID_PROD_VAR")"
            EXPECTED_ENV_SUFFIX="PROD"
          elif [ "$BRANCH_NAME" = "dev" ]; then
            PROJECT_ID="$(resolve_value "$FIREBASE_PROJECT_ID_DEV_SECRET" "$FIREBASE_PROJECT_ID_DEV_VAR")"
            if [ -z "$PROJECT_ID" ]; then
              PROJECT_ID="$(resolve_value "$VITE_FIREBASE_PROJECT_ID_DEV_SECRET" "$VITE_FIREBASE_PROJECT_ID_DEV_VAR")"
            fi
            API_BASE_URL="$(resolve_value "$VITE_API_BASE_URL_DEV_SECRET" "$VITE_API_BASE_URL_DEV_VAR")"
            WS_URL="$(resolve_value "$VITE_WS_URL_DEV_SECRET" "$VITE_WS_URL_DEV_VAR")"
            FB_API_KEY="$(resolve_value "$VITE_FIREBASE_API_KEY_DEV_SECRET" "$VITE_FIREBASE_API_KEY_DEV_VAR")"
            FB_AUTH_DOMAIN="$(resolve_value "$VITE_FIREBASE_AUTH_DOMAIN_DEV_SECRET" "$VITE_FIREBASE_AUTH_DOMAIN_DEV_VAR")"
            FB_PROJECT_ID="$(resolve_value "$VITE_FIREBASE_PROJECT_ID_DEV_SECRET" "$VITE_FIREBASE_PROJECT_ID_DEV_VAR")"
            FB_STORAGE_BUCKET="$(resolve_value "$VITE_FIREBASE_STORAGE_BUCKET_DEV_SECRET" "$VITE_FIREBASE_STORAGE_BUCKET_DEV_VAR")"
            FB_SENDER_ID="$(resolve_value "$VITE_FIREBASE_MESSAGING_SENDER_ID_DEV_SECRET" "$VITE_FIREBASE_MESSAGING_SENDER_ID_DEV_VAR")"
            FB_APP_ID="$(resolve_value "$VITE_FIREBASE_APP_ID_DEV_SECRET" "$VITE_FIREBASE_APP_ID_DEV_VAR")"
            FB_MEASUREMENT_ID="$(resolve_value "$VITE_FIREBASE_MEASUREMENT_ID_DEV_SECRET" "$VITE_FIREBASE_MEASUREMENT_ID_DEV_VAR")"
            EXPECTED_ENV_SUFFIX="DEV"
          else
            echo "Unsupported branch: $BRANCH_NAME"
            exit 1
          fi

          missing=()
          [ -z "${PROJECT_ID:-}" ] && missing+=("FIREBASE_PROJECT_ID_${EXPECTED_ENV_SUFFIX} (or VITE_FIREBASE_PROJECT_ID_${EXPECTED_ENV_SUFFIX})")
          [ -z "${API_BASE_URL:-}" ] && missing+=("VITE_API_BASE_URL_${EXPECTED_ENV_SUFFIX}")
          [ -z "${WS_URL:-}" ] && missing+=("VITE_WS_URL_${EXPECTED_ENV_SUFFIX}")
          [ -z "${FB_API_KEY:-}" ] && missing+=("VITE_FIREBASE_API_KEY_${EXPECTED_ENV_SUFFIX}")
          [ -z "${FB_AUTH_DOMAIN:-}" ] && missing+=("VITE_FIREBASE_AUTH_DOMAIN_${EXPECTED_ENV_SUFFIX}")
          [ -z "${FB_PROJECT_ID:-}" ] && missing+=("VITE_FIREBASE_PROJECT_ID_${EXPECTED_ENV_SUFFIX}")
          [ -z "${FB_STORAGE_BUCKET:-}" ] && missing+=("VITE_FIREBASE_STORAGE_BUCKET_${EXPECTED_ENV_SUFFIX}")
          [ -z "${FB_SENDER_ID:-}" ] && missing+=("VITE_FIREBASE_MESSAGING_SENDER_ID_${EXPECTED_ENV_SUFFIX}")
          [ -z "${FB_APP_ID:-}" ] && missing+=("VITE_FIREBASE_APP_ID_${EXPECTED_ENV_SUFFIX}")
          if [ "${#missing[@]}" -gt 0 ]; then
            echo "Missing required config for branch '$BRANCH_NAME':"
            printf ' - %s\n' "${missing[@]}"
            exit 1
          fi

          echo "project_id=$PROJECT_ID" >> "$GITHUB_OUTPUT"
          echo "api_base_url=$API_BASE_URL" >> "$GITHUB_OUTPUT"
          echo "ws_url=$WS_URL" >> "$GITHUB_OUTPUT"
          echo "fb_api_key=$FB_API_KEY" >> "$GITHUB_OUTPUT"
          echo "fb_auth_domain=$FB_AUTH_DOMAIN" >> "$GITHUB_OUTPUT"
          echo "fb_project_id=$FB_PROJECT_ID" >> "$GITHUB_OUTPUT"
          echo "fb_storage_bucket=$FB_STORAGE_BUCKET" >> "$GITHUB_OUTPUT"
          echo "fb_messaging_sender_id=$FB_SENDER_ID" >> "$GITHUB_OUTPUT"
          echo "fb_app_id=$FB_APP_ID" >> "$GITHUB_OUTPUT"
          echo "fb_measurement_id=$FB_MEASUREMENT_ID" >> "$GITHUB_OUTPUT"

      - name: Validate required secrets
        env:
          PROJECT_ID: ${{ steps.target.outputs.project_id }}
          API_BASE_URL: ${{ steps.target.outputs.api_base_url }}
          WS_URL: ${{ steps.target.outputs.ws_url }}
          FB_API_KEY: ${{ steps.target.outputs.fb_api_key }}
          FB_AUTH_DOMAIN: ${{ steps.target.outputs.fb_auth_domain }}
          FB_PROJECT_ID: ${{ steps.target.outputs.fb_project_id }}
          FB_STORAGE_BUCKET: ${{ steps.target.outputs.fb_storage_bucket }}
          FB_SENDER_ID: ${{ steps.target.outputs.fb_messaging_sender_id }}
          FB_APP_ID: ${{ steps.target.outputs.fb_app_id }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          set -euo pipefail
          for key in PROJECT_ID API_BASE_URL WS_URL FB_API_KEY FB_AUTH_DOMAIN FB_PROJECT_ID FB_STORAGE_BUCKET FB_SENDER_ID FB_APP_ID GCP_SA_KEY; do
            value="${!key:-}"
            if [ -z "$value" ]; then
              echo "Missing required secret/output: $key"
              exit 1
            fi
          done

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ steps.target.outputs.project_id }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ steps.target.outputs.project_id }}

      - name: Install dependencies
        run: npm ci

      - name: Generate build env
        env:
          API_BASE_URL: ${{ steps.target.outputs.api_base_url }}
          WS_URL: ${{ steps.target.outputs.ws_url }}
          FB_API_KEY: ${{ steps.target.outputs.fb_api_key }}
          FB_AUTH_DOMAIN: ${{ steps.target.outputs.fb_auth_domain }}
          FB_PROJECT_ID: ${{ steps.target.outputs.fb_project_id }}
          FB_STORAGE_BUCKET: ${{ steps.target.outputs.fb_storage_bucket }}
          FB_SENDER_ID: ${{ steps.target.outputs.fb_messaging_sender_id }}
          FB_APP_ID: ${{ steps.target.outputs.fb_app_id }}
          FB_MEASUREMENT_ID: ${{ steps.target.outputs.fb_measurement_id }}
        run: |
          cat > .env.production <<EOF
          VITE_API_BASE_URL=$API_BASE_URL
          VITE_WS_URL=$WS_URL
          VITE_FIREBASE_API_KEY=$FB_API_KEY
          VITE_FIREBASE_AUTH_DOMAIN=$FB_AUTH_DOMAIN
          VITE_FIREBASE_PROJECT_ID=$FB_PROJECT_ID
          VITE_FIREBASE_STORAGE_BUCKET=$FB_STORAGE_BUCKET
          VITE_FIREBASE_MESSAGING_SENDER_ID=$FB_SENDER_ID
          VITE_FIREBASE_APP_ID=$FB_APP_ID
          VITE_FIREBASE_MEASUREMENT_ID=$FB_MEASUREMENT_ID
          EOF

      - name: Build frontend
        run: npm run build:prod

      - name: Deploy API to Cloud Run
        id: deploy-api
        uses: google-github-actions/deploy-cloudrun@v3
        with:
          service: biscuits-api
          source: ./api
          region: us-central1
          flags: --allow-unauthenticated
          env_vars: |
            NODE_ENV=production
            WS_BASE_URL=${{ steps.target.outputs.ws_url }}

      - name: Deploy Firebase Hosting + Firestore
        env:
          PROJECT_ID: ${{ steps.target.outputs.project_id }}
        run: npx firebase-tools deploy --project "$PROJECT_ID" --only hosting,firestore --non-interactive

name: Deploy Firebase + Cloud Run

on:
  push:
    branches:
      - main
      - master
      - dev
  workflow_dispatch:
    inputs:
      deploy_api:
        description: Deploy Cloud Run API
        type: boolean
        default: true
      deploy_web:
        description: Build and deploy Firebase Hosting + Firestore
        type: boolean
        default: true
      deploy_assets:
        description: Deploy CDN assets to Firebase Storage
        type: boolean
        default: true
      run_api_smoke:
        description: Run API/WebSocket smoke test after API deploy
        type: boolean
        default: true

concurrency:
  group: deploy-${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  resolve_target:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.deploy_api || inputs.deploy_web }}
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'dev' && 'dev' || 'prod' }}
    outputs:
      project_id: ${{ steps.target.outputs.project_id }}
      api_base_url: ${{ steps.target.outputs.api_base_url }}
      ws_url: ${{ steps.target.outputs.ws_url }}
      asset_base_url: ${{ steps.target.outputs.asset_base_url }}
      fb_api_key: ${{ steps.target.outputs.fb_api_key }}
      fb_auth_domain: ${{ steps.target.outputs.fb_auth_domain }}
      fb_project_id: ${{ steps.target.outputs.fb_project_id }}
      fb_storage_bucket: ${{ steps.target.outputs.fb_storage_bucket }}
      fb_messaging_sender_id: ${{ steps.target.outputs.fb_messaging_sender_id }}
      fb_app_id: ${{ steps.target.outputs.fb_app_id }}
      fb_measurement_id: ${{ steps.target.outputs.fb_measurement_id }}

    steps:
      - &resolve_deployment_target_step
        name: Resolve Deployment Target
        id: target
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          FIREBASE_PROJECT_ID_ENV_SECRET: ${{ secrets.FIREBASE_PROJECT_ID }}
          VITE_API_BASE_URL_ENV_SECRET: ${{ secrets.VITE_API_BASE_URL }}
          VITE_WS_URL_ENV_SECRET: ${{ secrets.VITE_WS_URL }}
          VITE_FIREBASE_API_KEY_ENV_SECRET: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN_ENV_SECRET: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID_ENV_SECRET: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET_ENV_SECRET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID_ENV_SECRET: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID_ENV_SECRET: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID_ENV_SECRET: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
          FIREBASE_PROJECT_ID_PROD_SECRET: ${{ secrets.FIREBASE_PROJECT_ID_PROD }}
          FIREBASE_PROJECT_ID_DEV_SECRET: ${{ secrets.FIREBASE_PROJECT_ID_DEV }}
          VITE_API_BASE_URL_PROD_SECRET: ${{ secrets.VITE_API_BASE_URL_PROD }}
          VITE_API_BASE_URL_DEV_SECRET: ${{ secrets.VITE_API_BASE_URL_DEV }}
          VITE_WS_URL_PROD_SECRET: ${{ secrets.VITE_WS_URL_PROD }}
          VITE_WS_URL_DEV_SECRET: ${{ secrets.VITE_WS_URL_DEV }}
          VITE_FIREBASE_API_KEY_PROD_SECRET: ${{ secrets.VITE_FIREBASE_API_KEY_PROD }}
          VITE_FIREBASE_API_KEY_DEV_SECRET: ${{ secrets.VITE_FIREBASE_API_KEY_DEV }}
          VITE_FIREBASE_AUTH_DOMAIN_PROD_SECRET: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN_PROD }}
          VITE_FIREBASE_AUTH_DOMAIN_DEV_SECRET: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN_DEV }}
          VITE_FIREBASE_PROJECT_ID_PROD_SECRET: ${{ secrets.VITE_FIREBASE_PROJECT_ID_PROD }}
          VITE_FIREBASE_PROJECT_ID_DEV_SECRET: ${{ secrets.VITE_FIREBASE_PROJECT_ID_DEV }}
          VITE_FIREBASE_STORAGE_BUCKET_PROD_SECRET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET_PROD }}
          VITE_FIREBASE_STORAGE_BUCKET_DEV_SECRET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET_DEV }}
          VITE_FIREBASE_MESSAGING_SENDER_ID_PROD_SECRET: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID_PROD }}
          VITE_FIREBASE_MESSAGING_SENDER_ID_DEV_SECRET: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID_DEV }}
          VITE_FIREBASE_APP_ID_PROD_SECRET: ${{ secrets.VITE_FIREBASE_APP_ID_PROD }}
          VITE_FIREBASE_APP_ID_DEV_SECRET: ${{ secrets.VITE_FIREBASE_APP_ID_DEV }}
          VITE_FIREBASE_MEASUREMENT_ID_PROD_SECRET: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID_PROD }}
          VITE_FIREBASE_MEASUREMENT_ID_DEV_SECRET: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID_DEV }}
          FIREBASE_PROJECT_ID_ENV_VAR: ${{ vars.FIREBASE_PROJECT_ID }}
          VITE_API_BASE_URL_ENV_VAR: ${{ vars.VITE_API_BASE_URL }}
          VITE_WS_URL_ENV_VAR: ${{ vars.VITE_WS_URL }}
          VITE_FIREBASE_API_KEY_ENV_VAR: ${{ vars.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN_ENV_VAR: ${{ vars.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID_ENV_VAR: ${{ vars.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET_ENV_VAR: ${{ vars.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID_ENV_VAR: ${{ vars.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID_ENV_VAR: ${{ vars.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID_ENV_VAR: ${{ vars.VITE_FIREBASE_MEASUREMENT_ID }}
          CDN_REQUIRE_PUBLIC_READ_ENV_VAR: ${{ vars.CDN_REQUIRE_PUBLIC_READ }}
          FIREBASE_PROJECT_ID_PROD_VAR: ${{ vars.FIREBASE_PROJECT_ID_PROD }}
          FIREBASE_PROJECT_ID_DEV_VAR: ${{ vars.FIREBASE_PROJECT_ID_DEV }}
          VITE_API_BASE_URL_PROD_VAR: ${{ vars.VITE_API_BASE_URL_PROD }}
          VITE_API_BASE_URL_DEV_VAR: ${{ vars.VITE_API_BASE_URL_DEV }}
          VITE_WS_URL_PROD_VAR: ${{ vars.VITE_WS_URL_PROD }}
          VITE_WS_URL_DEV_VAR: ${{ vars.VITE_WS_URL_DEV }}
          VITE_FIREBASE_API_KEY_PROD_VAR: ${{ vars.VITE_FIREBASE_API_KEY_PROD }}
          VITE_FIREBASE_API_KEY_DEV_VAR: ${{ vars.VITE_FIREBASE_API_KEY_DEV }}
          VITE_FIREBASE_AUTH_DOMAIN_PROD_VAR: ${{ vars.VITE_FIREBASE_AUTH_DOMAIN_PROD }}
          VITE_FIREBASE_AUTH_DOMAIN_DEV_VAR: ${{ vars.VITE_FIREBASE_AUTH_DOMAIN_DEV }}
          VITE_FIREBASE_PROJECT_ID_PROD_VAR: ${{ vars.VITE_FIREBASE_PROJECT_ID_PROD }}
          VITE_FIREBASE_PROJECT_ID_DEV_VAR: ${{ vars.VITE_FIREBASE_PROJECT_ID_DEV }}
          VITE_FIREBASE_STORAGE_BUCKET_PROD_VAR: ${{ vars.VITE_FIREBASE_STORAGE_BUCKET_PROD }}
          VITE_FIREBASE_STORAGE_BUCKET_DEV_VAR: ${{ vars.VITE_FIREBASE_STORAGE_BUCKET_DEV }}
          VITE_FIREBASE_MESSAGING_SENDER_ID_PROD_VAR: ${{ vars.VITE_FIREBASE_MESSAGING_SENDER_ID_PROD }}
          VITE_FIREBASE_MESSAGING_SENDER_ID_DEV_VAR: ${{ vars.VITE_FIREBASE_MESSAGING_SENDER_ID_DEV }}
          VITE_FIREBASE_APP_ID_PROD_VAR: ${{ vars.VITE_FIREBASE_APP_ID_PROD }}
          VITE_FIREBASE_APP_ID_DEV_VAR: ${{ vars.VITE_FIREBASE_APP_ID_DEV }}
          VITE_FIREBASE_MEASUREMENT_ID_PROD_VAR: ${{ vars.VITE_FIREBASE_MEASUREMENT_ID_PROD }}
          VITE_FIREBASE_MEASUREMENT_ID_DEV_VAR: ${{ vars.VITE_FIREBASE_MEASUREMENT_ID_DEV }}
        run: |
          set -euo pipefail

          resolve_value() {
            local candidate=""
            for candidate in "$@"; do
              if [ -n "${candidate:-}" ]; then
                printf '%s' "$candidate"
                return 0
              fi
            done
            printf ''
          }

          if [ "$BRANCH_NAME" = "master" ] || [ "$BRANCH_NAME" = "main" ]; then
            PROJECT_ID="$(resolve_value "$FIREBASE_PROJECT_ID_PROD_SECRET" "$FIREBASE_PROJECT_ID_ENV_SECRET" "$FIREBASE_PROJECT_ID_PROD_VAR" "$FIREBASE_PROJECT_ID_ENV_VAR")"
            if [ -z "$PROJECT_ID" ]; then
              PROJECT_ID="$(resolve_value "$VITE_FIREBASE_PROJECT_ID_PROD_SECRET" "$VITE_FIREBASE_PROJECT_ID_ENV_SECRET" "$VITE_FIREBASE_PROJECT_ID_PROD_VAR" "$VITE_FIREBASE_PROJECT_ID_ENV_VAR")"
            fi
            API_BASE_URL="$(resolve_value "$VITE_API_BASE_URL_PROD_SECRET" "$VITE_API_BASE_URL_ENV_SECRET" "$VITE_API_BASE_URL_PROD_VAR" "$VITE_API_BASE_URL_ENV_VAR")"
            WS_URL="$(resolve_value "$VITE_WS_URL_PROD_SECRET" "$VITE_WS_URL_ENV_SECRET" "$VITE_WS_URL_PROD_VAR" "$VITE_WS_URL_ENV_VAR")"
            FB_API_KEY="$(resolve_value "$VITE_FIREBASE_API_KEY_PROD_SECRET" "$VITE_FIREBASE_API_KEY_ENV_SECRET" "$VITE_FIREBASE_API_KEY_PROD_VAR" "$VITE_FIREBASE_API_KEY_ENV_VAR")"
            FB_AUTH_DOMAIN="$(resolve_value "$VITE_FIREBASE_AUTH_DOMAIN_PROD_SECRET" "$VITE_FIREBASE_AUTH_DOMAIN_ENV_SECRET" "$VITE_FIREBASE_AUTH_DOMAIN_PROD_VAR" "$VITE_FIREBASE_AUTH_DOMAIN_ENV_VAR")"
            FB_PROJECT_ID="$(resolve_value "$VITE_FIREBASE_PROJECT_ID_PROD_SECRET" "$VITE_FIREBASE_PROJECT_ID_ENV_SECRET" "$VITE_FIREBASE_PROJECT_ID_PROD_VAR" "$VITE_FIREBASE_PROJECT_ID_ENV_VAR")"
            FB_STORAGE_BUCKET="$(resolve_value "$VITE_FIREBASE_STORAGE_BUCKET_PROD_SECRET" "$VITE_FIREBASE_STORAGE_BUCKET_ENV_SECRET" "$VITE_FIREBASE_STORAGE_BUCKET_PROD_VAR" "$VITE_FIREBASE_STORAGE_BUCKET_ENV_VAR")"
            FB_SENDER_ID="$(resolve_value "$VITE_FIREBASE_MESSAGING_SENDER_ID_PROD_SECRET" "$VITE_FIREBASE_MESSAGING_SENDER_ID_ENV_SECRET" "$VITE_FIREBASE_MESSAGING_SENDER_ID_PROD_VAR" "$VITE_FIREBASE_MESSAGING_SENDER_ID_ENV_VAR")"
            FB_APP_ID="$(resolve_value "$VITE_FIREBASE_APP_ID_PROD_SECRET" "$VITE_FIREBASE_APP_ID_ENV_SECRET" "$VITE_FIREBASE_APP_ID_PROD_VAR" "$VITE_FIREBASE_APP_ID_ENV_VAR")"
            FB_MEASUREMENT_ID="$(resolve_value "$VITE_FIREBASE_MEASUREMENT_ID_PROD_SECRET" "$VITE_FIREBASE_MEASUREMENT_ID_ENV_SECRET" "$VITE_FIREBASE_MEASUREMENT_ID_PROD_VAR" "$VITE_FIREBASE_MEASUREMENT_ID_ENV_VAR")"
            EXPECTED_ENV_SUFFIX="PROD"
            EXPECTED_ENV_NAME="prod"
          elif [ "$BRANCH_NAME" = "dev" ]; then
            PROJECT_ID="$(resolve_value "$FIREBASE_PROJECT_ID_DEV_SECRET" "$FIREBASE_PROJECT_ID_ENV_SECRET" "$FIREBASE_PROJECT_ID_DEV_VAR" "$FIREBASE_PROJECT_ID_ENV_VAR")"
            if [ -z "$PROJECT_ID" ]; then
              PROJECT_ID="$(resolve_value "$VITE_FIREBASE_PROJECT_ID_DEV_SECRET" "$VITE_FIREBASE_PROJECT_ID_ENV_SECRET" "$VITE_FIREBASE_PROJECT_ID_DEV_VAR" "$VITE_FIREBASE_PROJECT_ID_ENV_VAR")"
            fi
            API_BASE_URL="$(resolve_value "$VITE_API_BASE_URL_DEV_SECRET" "$VITE_API_BASE_URL_ENV_SECRET" "$VITE_API_BASE_URL_DEV_VAR" "$VITE_API_BASE_URL_ENV_VAR")"
            WS_URL="$(resolve_value "$VITE_WS_URL_DEV_SECRET" "$VITE_WS_URL_ENV_SECRET" "$VITE_WS_URL_DEV_VAR" "$VITE_WS_URL_ENV_VAR")"
            FB_API_KEY="$(resolve_value "$VITE_FIREBASE_API_KEY_DEV_SECRET" "$VITE_FIREBASE_API_KEY_ENV_SECRET" "$VITE_FIREBASE_API_KEY_DEV_VAR" "$VITE_FIREBASE_API_KEY_ENV_VAR")"
            FB_AUTH_DOMAIN="$(resolve_value "$VITE_FIREBASE_AUTH_DOMAIN_DEV_SECRET" "$VITE_FIREBASE_AUTH_DOMAIN_ENV_SECRET" "$VITE_FIREBASE_AUTH_DOMAIN_DEV_VAR" "$VITE_FIREBASE_AUTH_DOMAIN_ENV_VAR")"
            FB_PROJECT_ID="$(resolve_value "$VITE_FIREBASE_PROJECT_ID_DEV_SECRET" "$VITE_FIREBASE_PROJECT_ID_ENV_SECRET" "$VITE_FIREBASE_PROJECT_ID_DEV_VAR" "$VITE_FIREBASE_PROJECT_ID_ENV_VAR")"
            FB_STORAGE_BUCKET="$(resolve_value "$VITE_FIREBASE_STORAGE_BUCKET_DEV_SECRET" "$VITE_FIREBASE_STORAGE_BUCKET_ENV_SECRET" "$VITE_FIREBASE_STORAGE_BUCKET_DEV_VAR" "$VITE_FIREBASE_STORAGE_BUCKET_ENV_VAR")"
            FB_SENDER_ID="$(resolve_value "$VITE_FIREBASE_MESSAGING_SENDER_ID_DEV_SECRET" "$VITE_FIREBASE_MESSAGING_SENDER_ID_ENV_SECRET" "$VITE_FIREBASE_MESSAGING_SENDER_ID_DEV_VAR" "$VITE_FIREBASE_MESSAGING_SENDER_ID_ENV_VAR")"
            FB_APP_ID="$(resolve_value "$VITE_FIREBASE_APP_ID_DEV_SECRET" "$VITE_FIREBASE_APP_ID_ENV_SECRET" "$VITE_FIREBASE_APP_ID_DEV_VAR" "$VITE_FIREBASE_APP_ID_ENV_VAR")"
            FB_MEASUREMENT_ID="$(resolve_value "$VITE_FIREBASE_MEASUREMENT_ID_DEV_SECRET" "$VITE_FIREBASE_MEASUREMENT_ID_ENV_SECRET" "$VITE_FIREBASE_MEASUREMENT_ID_DEV_VAR" "$VITE_FIREBASE_MEASUREMENT_ID_ENV_VAR")"
            EXPECTED_ENV_SUFFIX="DEV"
            EXPECTED_ENV_NAME="dev"
          else
            echo "Unsupported branch: $BRANCH_NAME"
            exit 1
          fi

          missing=()
          [ -z "${PROJECT_ID:-}" ] && missing+=("FIREBASE_PROJECT_ID_${EXPECTED_ENV_SUFFIX} or FIREBASE_PROJECT_ID (fallback: VITE_FIREBASE_PROJECT_ID_${EXPECTED_ENV_SUFFIX} / VITE_FIREBASE_PROJECT_ID)")
          [ -z "${API_BASE_URL:-}" ] && missing+=("VITE_API_BASE_URL_${EXPECTED_ENV_SUFFIX} or VITE_API_BASE_URL")
          [ -z "${WS_URL:-}" ] && missing+=("VITE_WS_URL_${EXPECTED_ENV_SUFFIX} or VITE_WS_URL")
          [ -z "${FB_API_KEY:-}" ] && missing+=("VITE_FIREBASE_API_KEY_${EXPECTED_ENV_SUFFIX} or VITE_FIREBASE_API_KEY")
          [ -z "${FB_AUTH_DOMAIN:-}" ] && missing+=("VITE_FIREBASE_AUTH_DOMAIN_${EXPECTED_ENV_SUFFIX} or VITE_FIREBASE_AUTH_DOMAIN")
          [ -z "${FB_PROJECT_ID:-}" ] && missing+=("VITE_FIREBASE_PROJECT_ID_${EXPECTED_ENV_SUFFIX} or VITE_FIREBASE_PROJECT_ID")
          [ -z "${FB_STORAGE_BUCKET:-}" ] && missing+=("VITE_FIREBASE_STORAGE_BUCKET_${EXPECTED_ENV_SUFFIX} or VITE_FIREBASE_STORAGE_BUCKET")
          [ -z "${FB_SENDER_ID:-}" ] && missing+=("VITE_FIREBASE_MESSAGING_SENDER_ID_${EXPECTED_ENV_SUFFIX} or VITE_FIREBASE_MESSAGING_SENDER_ID")
          [ -z "${FB_APP_ID:-}" ] && missing+=("VITE_FIREBASE_APP_ID_${EXPECTED_ENV_SUFFIX} or VITE_FIREBASE_APP_ID")
          if [ "${#missing[@]}" -gt 0 ]; then
            echo "Missing required config for branch '$BRANCH_NAME' (GitHub Environment: '$EXPECTED_ENV_NAME'):"
            printf ' - %s\n' "${missing[@]}"
            exit 1
          fi

          if [ "$PROJECT_ID" != "$FB_PROJECT_ID" ]; then
            echo "Configuration mismatch detected for branch '$BRANCH_NAME' (GitHub Environment: '$EXPECTED_ENV_NAME'):"
            echo " - FIREBASE_PROJECT_ID resolved to: $PROJECT_ID"
            echo " - VITE_FIREBASE_PROJECT_ID resolved to: $FB_PROJECT_ID"
            echo "These must match to avoid mixed-project auth and unauthorized-domain failures."
            echo "Update FIREBASE_PROJECT_ID_${EXPECTED_ENV_SUFFIX}/FIREBASE_PROJECT_ID and VITE_FIREBASE_PROJECT_ID_${EXPECTED_ENV_SUFFIX}/VITE_FIREBASE_PROJECT_ID to the same project."
            exit 1
          fi

          if [[ "$FB_AUTH_DOMAIN" != *"$FB_PROJECT_ID"* ]]; then
            echo "Configuration mismatch detected for branch '$BRANCH_NAME' (GitHub Environment: '$EXPECTED_ENV_NAME'):"
            echo " - VITE_FIREBASE_AUTH_DOMAIN resolved to: $FB_AUTH_DOMAIN"
            echo " - VITE_FIREBASE_PROJECT_ID resolved to: $FB_PROJECT_ID"
            echo "Auth domain should belong to the same Firebase project (usually ${FB_PROJECT_ID}.firebaseapp.com)."
            exit 1
          fi

          if [[ "$FB_STORAGE_BUCKET" != *"$FB_PROJECT_ID"* ]]; then
            echo "Configuration mismatch detected for branch '$BRANCH_NAME' (GitHub Environment: '$EXPECTED_ENV_NAME'):"
            echo " - VITE_FIREBASE_STORAGE_BUCKET resolved to: $FB_STORAGE_BUCKET"
            echo " - VITE_FIREBASE_PROJECT_ID resolved to: $FB_PROJECT_ID"
            echo "Storage bucket should belong to the same Firebase project."
            exit 1
          fi

          CDN_REQUIRE_PUBLIC_READ="$(printf '%s' "${CDN_REQUIRE_PUBLIC_READ_ENV_VAR:-0}" | tr '[:upper:]' '[:lower:]')"
          CDN_PUBLIC_MODE="0"
          if [ "$CDN_REQUIRE_PUBLIC_READ" = "1" ] || [ "$CDN_REQUIRE_PUBLIC_READ" = "true" ] || [ "$CDN_REQUIRE_PUBLIC_READ" = "yes" ] || [ "$CDN_REQUIRE_PUBLIC_READ" = "on" ]; then
            CDN_PUBLIC_MODE="1"
          fi

          NORMALIZED_BUCKET="${FB_STORAGE_BUCKET#gs://}"
          NORMALIZED_BUCKET="${NORMALIZED_BUCKET%/}"

          # Canonical asset URL policy:
          # - Public CDN mode: always use storage.googleapis.com/<resolved-storage-bucket>/
          # - Private mode: always use Hosting-local asset paths
          if [ "$CDN_PUBLIC_MODE" = "1" ]; then
            ASSET_BASE_URL="https://storage.googleapis.com/${NORMALIZED_BUCKET}/"
            echo "Asset base URL set from resolved storage bucket: $ASSET_BASE_URL"
          else
            ASSET_BASE_URL=""
            echo "Private CDN mode enabled; frontend will use Hosting-local assets."
          fi

          if [ -n "${ASSET_BASE_URL:-}" ] && [ "${ASSET_BASE_URL%/}" = "$ASSET_BASE_URL" ]; then
            ASSET_BASE_URL="${ASSET_BASE_URL}/"
          fi

          echo "project_id=$PROJECT_ID" >> "$GITHUB_OUTPUT"
          echo "api_base_url=$API_BASE_URL" >> "$GITHUB_OUTPUT"
          echo "ws_url=$WS_URL" >> "$GITHUB_OUTPUT"
          echo "asset_base_url=$ASSET_BASE_URL" >> "$GITHUB_OUTPUT"
          echo "fb_api_key=$FB_API_KEY" >> "$GITHUB_OUTPUT"
          echo "fb_auth_domain=$FB_AUTH_DOMAIN" >> "$GITHUB_OUTPUT"
          echo "fb_project_id=$FB_PROJECT_ID" >> "$GITHUB_OUTPUT"
          echo "fb_storage_bucket=$FB_STORAGE_BUCKET" >> "$GITHUB_OUTPUT"
          echo "fb_messaging_sender_id=$FB_SENDER_ID" >> "$GITHUB_OUTPUT"
          echo "fb_app_id=$FB_APP_ID" >> "$GITHUB_OUTPUT"
          echo "fb_measurement_id=$FB_MEASUREMENT_ID" >> "$GITHUB_OUTPUT"

  deploy-api:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.deploy_api }}
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'dev' && 'dev' || 'prod' }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - *resolve_deployment_target_step

      - name: Validate required secrets
        env:
          PROJECT_ID: ${{ steps.target.outputs.project_id }}
          API_BASE_URL: ${{ steps.target.outputs.api_base_url }}
          WS_URL: ${{ steps.target.outputs.ws_url }}
          FB_API_KEY: ${{ steps.target.outputs.fb_api_key }}
          FB_AUTH_DOMAIN: ${{ steps.target.outputs.fb_auth_domain }}
          FB_PROJECT_ID: ${{ steps.target.outputs.fb_project_id }}
          FB_STORAGE_BUCKET: ${{ steps.target.outputs.fb_storage_bucket }}
          FB_SENDER_ID: ${{ steps.target.outputs.fb_messaging_sender_id }}
          FB_APP_ID: ${{ steps.target.outputs.fb_app_id }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_SA_KEY_B64: ${{ secrets.GCP_SA_KEY_B64 }}
        run: |
          set -euo pipefail
          for key in PROJECT_ID API_BASE_URL WS_URL FB_API_KEY FB_AUTH_DOMAIN FB_PROJECT_ID FB_STORAGE_BUCKET FB_SENDER_ID FB_APP_ID; do
            value="${!key:-}"
            if [ -z "$value" ]; then
              echo "Missing required secret/output: $key"
              exit 1
            fi
          done
          if [ -z "${GCP_SA_KEY:-}" ] && [ -z "${GCP_SA_KEY_B64:-}" ]; then
            echo "Missing required secret: GCP_SA_KEY (raw JSON) or GCP_SA_KEY_B64 (base64 JSON)"
            exit 1
          fi

      - name: Normalize Google credentials
        id: gcp-creds
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_SA_KEY_B64: ${{ secrets.GCP_SA_KEY_B64 }}
        run: |
          set -euo pipefail

          RAW="${GCP_SA_KEY:-}"
          if [ -z "$RAW" ] && [ -n "${GCP_SA_KEY_B64:-}" ]; then
            RAW="$GCP_SA_KEY_B64"
          fi

          if printf '%s' "$RAW" | jq -e . >/dev/null 2>&1; then
            CREDENTIALS_JSON="$RAW"
          else
            DECODED="$(printf '%s' "$RAW" | base64 --decode 2>/dev/null || true)"
            if [ -z "$DECODED" ]; then
              DECODED="$(printf '%s' "$RAW" | base64 -d 2>/dev/null || true)"
            fi
            if [ -z "$DECODED" ] || ! printf '%s' "$DECODED" | jq -e . >/dev/null 2>&1; then
              echo "Service account key is not valid JSON."
              echo "Set GCP_SA_KEY to raw JSON or GCP_SA_KEY_B64 to base64(JSON)."
              exit 1
            fi
            CREDENTIALS_JSON="$DECODED"
          fi

          if ! printf '%s' "$CREDENTIALS_JSON" | jq -e '.type == "service_account" and (.client_email|type=="string") and (.private_key|type=="string")' >/dev/null 2>&1; then
            echo "Credentials JSON is missing required service account fields."
            exit 1
          fi

          {
            echo "credentials_json<<EOF"
            printf '%s\n' "$CREDENTIALS_JSON"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ steps.gcp-creds.outputs.credentials_json }}
          project_id: ${{ steps.target.outputs.project_id }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ steps.target.outputs.project_id }}

      - name: Deploy API to Cloud Run
        id: deploy-api
        uses: google-github-actions/deploy-cloudrun@v3
        with:
          service: biscuits-api
          source: ./api
          region: us-central1
          flags: --allow-unauthenticated --max-instances=${{ vars.API_MAX_INSTANCES || '1' }}
          env_vars: |
            NODE_ENV=production
            WS_BASE_URL=${{ steps.target.outputs.ws_url }}
            FIREBASE_PROJECT_ID=${{ steps.target.outputs.fb_project_id }}
            FIREBASE_WEB_API_KEY=${{ steps.target.outputs.fb_api_key }}
            API_STORE_BACKEND=${{ vars.API_STORE_BACKEND || 'firestore' }}
            API_FIRESTORE_PREFIX=${{ vars.API_FIRESTORE_PREFIX || 'api_v1' }}
            FIREBASE_AUTH_MODE=${{ vars.FIREBASE_AUTH_MODE || 'auto' }}
            API_ADMIN_ACCESS_MODE=${{ vars.API_ADMIN_ACCESS_MODE || 'hybrid' }}
            API_ADMIN_TOKEN=${{ secrets.API_ADMIN_TOKEN }}
            ALLOW_SHORT_SESSION_TTLS=0
            MULTIPLAYER_SESSION_IDLE_TTL_MS=${{ vars.MULTIPLAYER_SESSION_IDLE_TTL_MS || '1800000' }}

      - name: Cloud Run deploy diagnostics (on failure)
        if: ${{ failure() && steps.deploy-api.outcome == 'failure' }}
        env:
          SERVICE_NAME: biscuits-api
          REGION: us-central1
        run: |
          set +e
          echo "Cloud Run service status:"
          gcloud run services describe "$SERVICE_NAME" \
            --region "$REGION" \
            --format='yaml(status.conditions,status.latestCreatedRevisionName,status.latestReadyRevisionName)' || true

          REVISION_NAME="$(gcloud run services describe "$SERVICE_NAME" --region "$REGION" --format='value(status.latestCreatedRevisionName)')"
          if [ -n "$REVISION_NAME" ]; then
            echo "Cloud Run revision status for $REVISION_NAME:"
            gcloud run revisions describe "$REVISION_NAME" \
              --region "$REGION" \
              --format='yaml(status.conditions)' || true

            echo "Recent logs for $REVISION_NAME:"
            gcloud logging read \
              "resource.type=cloud_run_revision AND resource.labels.service_name=$SERVICE_NAME AND resource.labels.revision_name=$REVISION_NAME" \
              --limit=200 \
              --format='table(timestamp,severity,textPayload,jsonPayload.message)' || true
          else
            echo "No created revision found; dumping recent service logs."
            gcloud run services logs read "$SERVICE_NAME" --region "$REGION" --limit=200 || true
          fi

          # Never fail this diagnostics helper step; preserve original deploy outcome.
          exit 0

      - name: Smoke Test Cloud Run API + WebSocket
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.run_api_smoke }}
        env:
          E2E_API_BASE_URL: ${{ steps.deploy-api.outputs.url }}
          E2E_FIREBASE_ID_TOKEN: ${{ secrets.E2E_FIREBASE_ID_TOKEN }}
          E2E_ADMIN_TOKEN: ${{ secrets.API_ADMIN_TOKEN }}
          E2E_QUEUE_LIFECYCLE_WAIT_MS: ${{ vars.E2E_QUEUE_LIFECYCLE_WAIT_MS || '90000' }}
          E2E_ASSERT_STORAGE_CUTOVER: ${{ (secrets.API_ADMIN_TOKEN != '' || secrets.E2E_FIREBASE_ID_TOKEN != '') && '1' || '0' }}
          E2E_EXPECT_STORAGE_BACKEND: ${{ vars.API_STORE_BACKEND || 'firestore' }}
          E2E_EXPECT_FIRESTORE_PREFIX: ${{ vars.API_FIRESTORE_PREFIX || 'api_v1' }}
          E2E_EXPECT_STORAGE_SECTION_MIN_COUNTS: ${{ vars.E2E_EXPECT_STORAGE_SECTION_MIN_COUNTS || '' }}
        run: |
          set -euo pipefail
          if [ -z "${E2E_API_BASE_URL:-}" ]; then
            echo "Missing deploy-cloudrun output URL."
            exit 1
          fi
          if [ "${E2E_ASSERT_STORAGE_CUTOVER}" = "0" ]; then
            echo "Skipping admin storage cutover assertion (no API_ADMIN_TOKEN or E2E_FIREBASE_ID_TOKEN configured)."
          fi
          node api/e2e/smoke.mjs

  deploy-web:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.deploy_web }}
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'dev' && 'dev' || 'prod' }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - *resolve_deployment_target_step

      - name: Validate required secrets
        env:
          PROJECT_ID: ${{ steps.target.outputs.project_id }}
          API_BASE_URL: ${{ steps.target.outputs.api_base_url }}
          WS_URL: ${{ steps.target.outputs.ws_url }}
          FB_API_KEY: ${{ steps.target.outputs.fb_api_key }}
          FB_AUTH_DOMAIN: ${{ steps.target.outputs.fb_auth_domain }}
          FB_PROJECT_ID: ${{ steps.target.outputs.fb_project_id }}
          FB_STORAGE_BUCKET: ${{ steps.target.outputs.fb_storage_bucket }}
          FB_SENDER_ID: ${{ steps.target.outputs.fb_messaging_sender_id }}
          FB_APP_ID: ${{ steps.target.outputs.fb_app_id }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_SA_KEY_B64: ${{ secrets.GCP_SA_KEY_B64 }}
        run: |
          set -euo pipefail
          for key in PROJECT_ID API_BASE_URL WS_URL FB_API_KEY FB_AUTH_DOMAIN FB_PROJECT_ID FB_STORAGE_BUCKET FB_SENDER_ID FB_APP_ID; do
            value="${!key:-}"
            if [ -z "$value" ]; then
              echo "Missing required secret/output: $key"
              exit 1
            fi
          done
          if [ -z "${GCP_SA_KEY:-}" ] && [ -z "${GCP_SA_KEY_B64:-}" ]; then
            echo "Missing required secret: GCP_SA_KEY (raw JSON) or GCP_SA_KEY_B64 (base64 JSON)"
            exit 1
          fi

      - name: Normalize Google credentials
        id: gcp-creds
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_SA_KEY_B64: ${{ secrets.GCP_SA_KEY_B64 }}
        run: |
          set -euo pipefail

          RAW="${GCP_SA_KEY:-}"
          if [ -z "$RAW" ] && [ -n "${GCP_SA_KEY_B64:-}" ]; then
            RAW="$GCP_SA_KEY_B64"
          fi

          if printf '%s' "$RAW" | jq -e . >/dev/null 2>&1; then
            CREDENTIALS_JSON="$RAW"
          else
            DECODED="$(printf '%s' "$RAW" | base64 --decode 2>/dev/null || true)"
            if [ -z "$DECODED" ]; then
              DECODED="$(printf '%s' "$RAW" | base64 -d 2>/dev/null || true)"
            fi
            if [ -z "$DECODED" ] || ! printf '%s' "$DECODED" | jq -e . >/dev/null 2>&1; then
              echo "Service account key is not valid JSON."
              echo "Set GCP_SA_KEY to raw JSON or GCP_SA_KEY_B64 to base64(JSON)."
              exit 1
            fi
            CREDENTIALS_JSON="$DECODED"
          fi

          if ! printf '%s' "$CREDENTIALS_JSON" | jq -e '.type == "service_account" and (.client_email|type=="string") and (.private_key|type=="string")' >/dev/null 2>&1; then
            echo "Credentials JSON is missing required service account fields."
            exit 1
          fi

          {
            echo "credentials_json<<EOF"
            printf '%s\n' "$CREDENTIALS_JSON"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ steps.gcp-creds.outputs.credentials_json }}
          project_id: ${{ steps.target.outputs.project_id }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ steps.target.outputs.project_id }}

      - name: Install dependencies
        run: npm ci

      - name: Generate build env
        env:
          API_BASE_URL: ${{ steps.target.outputs.api_base_url }}
          WS_URL: ${{ steps.target.outputs.ws_url }}
          ASSET_BASE_URL: ${{ steps.target.outputs.asset_base_url }}
          FB_API_KEY: ${{ steps.target.outputs.fb_api_key }}
          FB_AUTH_DOMAIN: ${{ steps.target.outputs.fb_auth_domain }}
          FB_PROJECT_ID: ${{ steps.target.outputs.fb_project_id }}
          FB_STORAGE_BUCKET: ${{ steps.target.outputs.fb_storage_bucket }}
          FB_SENDER_ID: ${{ steps.target.outputs.fb_messaging_sender_id }}
          FB_APP_ID: ${{ steps.target.outputs.fb_app_id }}
          FB_MEASUREMENT_ID: ${{ steps.target.outputs.fb_measurement_id }}
          OG_IMAGE_URL: ${{ vars.VITE_OG_IMAGE_URL }}
          FACEBOOK_APP_ID: ${{ vars.VITE_FACEBOOK_APP_ID }}
          FEEDBACK_FORM_URL_SECRET: ${{ secrets.FEEDBACK_FORM_URL }}
          FEEDBACK_FORM_URL_VAR: ${{ vars.FEEDBACK_FORM_URL }}
          VITE_FEEDBACK_FORM_URL_SECRET: ${{ secrets.VITE_FEEDBACK_FORM_URL }}
          VITE_FEEDBACK_FORM_URL_VAR: ${{ vars.VITE_FEEDBACK_FORM_URL }}
        run: |
          FEEDBACK_FORM_URL="${FEEDBACK_FORM_URL_SECRET:-${FEEDBACK_FORM_URL_VAR:-${VITE_FEEDBACK_FORM_URL_SECRET:-${VITE_FEEDBACK_FORM_URL_VAR:-/feedback}}}}"
          cat > .env.production <<EOF
          VITE_API_BASE_URL=$API_BASE_URL
          VITE_WS_URL=$WS_URL
          VITE_ASSET_BASE_URL=$ASSET_BASE_URL
          VITE_FEEDBACK_FORM_URL=$FEEDBACK_FORM_URL
          VITE_FIREBASE_API_KEY=$FB_API_KEY
          VITE_FIREBASE_AUTH_DOMAIN=$FB_AUTH_DOMAIN
          VITE_FIREBASE_PROJECT_ID=$FB_PROJECT_ID
          VITE_FIREBASE_STORAGE_BUCKET=$FB_STORAGE_BUCKET
          VITE_FIREBASE_MESSAGING_SENDER_ID=$FB_SENDER_ID
          VITE_FIREBASE_APP_ID=$FB_APP_ID
          VITE_FIREBASE_MEASUREMENT_ID=$FB_MEASUREMENT_ID
          VITE_ENABLE_ADMIN_UI=${{ vars.VITE_ENABLE_ADMIN_UI || '0' }}
          VITE_OG_IMAGE_URL=$OG_IMAGE_URL
          VITE_FACEBOOK_APP_ID=$FACEBOOK_APP_ID
          EOF

      - name: Build frontend
        run: npm run build:prod

      - name: Deploy Firebase Hosting + Firestore
        env:
          PROJECT_ID: ${{ steps.target.outputs.project_id }}
          FIREBASE_HOSTING_SITE_SECRET: ${{ secrets.FIREBASE_HOSTING_SITE }}
          FIREBASE_HOSTING_SITE_VAR: ${{ vars.FIREBASE_HOSTING_SITE }}
          FEEDBACK_FORM_URL_SECRET: ${{ secrets.FEEDBACK_FORM_URL }}
          FEEDBACK_FORM_URL_VAR: ${{ vars.FEEDBACK_FORM_URL }}
          VITE_FEEDBACK_FORM_URL_SECRET: ${{ secrets.VITE_FEEDBACK_FORM_URL }}
          VITE_FEEDBACK_FORM_URL_VAR: ${{ vars.VITE_FEEDBACK_FORM_URL }}
        run: |
          set -euo pipefail
          SITE_ID="${FIREBASE_HOSTING_SITE_SECRET:-${FIREBASE_HOSTING_SITE_VAR:-$PROJECT_ID}}"
          FEEDBACK_FORM_URL="${FEEDBACK_FORM_URL_SECRET:-${FEEDBACK_FORM_URL_VAR:-${VITE_FEEDBACK_FORM_URL_SECRET:-${VITE_FEEDBACK_FORM_URL_VAR:-https://docs.google.com/forms/d/e/1FAIpQLSeB0EGnrvQ5G3sbyOoW9rtcA1BNPbZo_NCFRejntquZ-z1o6w/viewform}}}}"

          echo "Deploy project: $PROJECT_ID"
          echo "Hosting site target: $SITE_ID"
          echo "Feedback redirect destination resolved."

          FEEDBACK_FORM_URL="$FEEDBACK_FORM_URL" node <<'EOF'
          const fs = require("node:fs");
          const sourceConfigPath = "firebase.json";
          const deployConfigPath = "firebase.deploy.json";
          const feedbackDestination = process.env.FEEDBACK_FORM_URL;

          const config = JSON.parse(fs.readFileSync(sourceConfigPath, "utf8"));
          const hosting = (config.hosting ??= {});
          const redirects = Array.isArray(hosting.redirects) ? hosting.redirects : [];
          hosting.redirects = [
            { source: "/feedback", destination: feedbackDestination, type: 302 },
            ...redirects.filter((entry) => entry?.source !== "/feedback"),
          ];

          fs.writeFileSync(deployConfigPath, `${JSON.stringify(config, null, 2)}\n`, "utf8");
          EOF

          # Ensure a deterministic hosting target for this project in CI.
          npx firebase-tools@15.8.0 target:apply hosting app "$SITE_ID" --project "$PROJECT_ID" --non-interactive
          npx firebase-tools@15.8.0 deploy --config firebase.deploy.json --project "$PROJECT_ID" --only firestore,hosting:app --non-interactive

  deploy-assets:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.deploy_assets }}
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'dev' && 'dev' || 'prod' }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Resolve Asset Deployment Target
        id: target-assets
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          FIREBASE_PROJECT_ID_ENV_SECRET: ${{ secrets.FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_PROJECT_ID_ENV_SECRET: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET_ENV_SECRET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          FIREBASE_PROJECT_ID_PROD_SECRET: ${{ secrets.FIREBASE_PROJECT_ID_PROD }}
          FIREBASE_PROJECT_ID_DEV_SECRET: ${{ secrets.FIREBASE_PROJECT_ID_DEV }}
          VITE_FIREBASE_PROJECT_ID_PROD_SECRET: ${{ secrets.VITE_FIREBASE_PROJECT_ID_PROD }}
          VITE_FIREBASE_PROJECT_ID_DEV_SECRET: ${{ secrets.VITE_FIREBASE_PROJECT_ID_DEV }}
          VITE_FIREBASE_STORAGE_BUCKET_PROD_SECRET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET_PROD }}
          VITE_FIREBASE_STORAGE_BUCKET_DEV_SECRET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET_DEV }}
          FIREBASE_PROJECT_ID_ENV_VAR: ${{ vars.FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_PROJECT_ID_ENV_VAR: ${{ vars.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET_ENV_VAR: ${{ vars.VITE_FIREBASE_STORAGE_BUCKET }}
          FIREBASE_PROJECT_ID_PROD_VAR: ${{ vars.FIREBASE_PROJECT_ID_PROD }}
          FIREBASE_PROJECT_ID_DEV_VAR: ${{ vars.FIREBASE_PROJECT_ID_DEV }}
          VITE_FIREBASE_PROJECT_ID_PROD_VAR: ${{ vars.VITE_FIREBASE_PROJECT_ID_PROD }}
          VITE_FIREBASE_PROJECT_ID_DEV_VAR: ${{ vars.VITE_FIREBASE_PROJECT_ID_DEV }}
          VITE_FIREBASE_STORAGE_BUCKET_PROD_VAR: ${{ vars.VITE_FIREBASE_STORAGE_BUCKET_PROD }}
          VITE_FIREBASE_STORAGE_BUCKET_DEV_VAR: ${{ vars.VITE_FIREBASE_STORAGE_BUCKET_DEV }}
        run: |
          set -euo pipefail

          resolve_value() {
            local candidate=""
            for candidate in "$@"; do
              if [ -n "${candidate:-}" ]; then
                printf '%s' "$candidate"
                return 0
              fi
            done
            printf ''
          }

          if [ "$BRANCH_NAME" = "master" ] || [ "$BRANCH_NAME" = "main" ]; then
            PROJECT_ID="$(resolve_value "$FIREBASE_PROJECT_ID_PROD_SECRET" "$FIREBASE_PROJECT_ID_ENV_SECRET" "$FIREBASE_PROJECT_ID_PROD_VAR" "$FIREBASE_PROJECT_ID_ENV_VAR")"
            if [ -z "$PROJECT_ID" ]; then
              PROJECT_ID="$(resolve_value "$VITE_FIREBASE_PROJECT_ID_PROD_SECRET" "$VITE_FIREBASE_PROJECT_ID_ENV_SECRET" "$VITE_FIREBASE_PROJECT_ID_PROD_VAR" "$VITE_FIREBASE_PROJECT_ID_ENV_VAR")"
            fi
            FB_STORAGE_BUCKET="$(resolve_value "$VITE_FIREBASE_STORAGE_BUCKET_PROD_SECRET" "$VITE_FIREBASE_STORAGE_BUCKET_ENV_SECRET" "$VITE_FIREBASE_STORAGE_BUCKET_PROD_VAR" "$VITE_FIREBASE_STORAGE_BUCKET_ENV_VAR")"
            EXPECTED_ENV_NAME="prod"
          elif [ "$BRANCH_NAME" = "dev" ]; then
            PROJECT_ID="$(resolve_value "$FIREBASE_PROJECT_ID_DEV_SECRET" "$FIREBASE_PROJECT_ID_ENV_SECRET" "$FIREBASE_PROJECT_ID_DEV_VAR" "$FIREBASE_PROJECT_ID_ENV_VAR")"
            if [ -z "$PROJECT_ID" ]; then
              PROJECT_ID="$(resolve_value "$VITE_FIREBASE_PROJECT_ID_DEV_SECRET" "$VITE_FIREBASE_PROJECT_ID_ENV_SECRET" "$VITE_FIREBASE_PROJECT_ID_DEV_VAR" "$VITE_FIREBASE_PROJECT_ID_ENV_VAR")"
            fi
            FB_STORAGE_BUCKET="$(resolve_value "$VITE_FIREBASE_STORAGE_BUCKET_DEV_SECRET" "$VITE_FIREBASE_STORAGE_BUCKET_ENV_SECRET" "$VITE_FIREBASE_STORAGE_BUCKET_DEV_VAR" "$VITE_FIREBASE_STORAGE_BUCKET_ENV_VAR")"
            EXPECTED_ENV_NAME="dev"
          else
            echo "Unsupported branch: $BRANCH_NAME"
            exit 1
          fi

          if [ -z "${PROJECT_ID:-}" ]; then
            echo "Missing project id for branch '$BRANCH_NAME' (GitHub Environment '$EXPECTED_ENV_NAME')."
            exit 1
          fi
          if [ -z "${FB_STORAGE_BUCKET:-}" ]; then
            FB_STORAGE_BUCKET="${PROJECT_ID}.firebasestorage.app"
            echo "Storage bucket not explicitly configured; defaulting candidate to: $FB_STORAGE_BUCKET"
          fi

          echo "project_id=$PROJECT_ID" >> "$GITHUB_OUTPUT"
          echo "fb_storage_bucket=$FB_STORAGE_BUCKET" >> "$GITHUB_OUTPUT"

      - name: Validate asset deployment inputs
        env:
          PROJECT_ID: ${{ steps.target-assets.outputs.project_id }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_SA_KEY_B64: ${{ secrets.GCP_SA_KEY_B64 }}
        run: |
          set -euo pipefail
          [ -z "${PROJECT_ID:-}" ] && { echo "Missing resolved target: project_id"; exit 1; }
          if [ -z "${GCP_SA_KEY:-}" ] && [ -z "${GCP_SA_KEY_B64:-}" ]; then
            echo "Missing required secret: GCP_SA_KEY (raw JSON) or GCP_SA_KEY_B64 (base64 JSON)"
            exit 1
          fi

      - name: Normalize Google credentials
        id: gcp-creds
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_SA_KEY_B64: ${{ secrets.GCP_SA_KEY_B64 }}
        run: |
          set -euo pipefail

          RAW="${GCP_SA_KEY:-}"
          if [ -z "$RAW" ] && [ -n "${GCP_SA_KEY_B64:-}" ]; then
            RAW="$GCP_SA_KEY_B64"
          fi

          if printf '%s' "$RAW" | jq -e . >/dev/null 2>&1; then
            CREDENTIALS_JSON="$RAW"
          else
            DECODED="$(printf '%s' "$RAW" | base64 --decode 2>/dev/null || true)"
            if [ -z "$DECODED" ]; then
              DECODED="$(printf '%s' "$RAW" | base64 -d 2>/dev/null || true)"
            fi
            if [ -z "$DECODED" ] || ! printf '%s' "$DECODED" | jq -e . >/dev/null 2>&1; then
              echo "Service account key is not valid JSON."
              echo "Set GCP_SA_KEY to raw JSON or GCP_SA_KEY_B64 to base64(JSON)."
              exit 1
            fi
            CREDENTIALS_JSON="$DECODED"
          fi

          if ! printf '%s' "$CREDENTIALS_JSON" | jq -e '.type == "service_account" and (.client_email|type=="string") and (.private_key|type=="string")' >/dev/null 2>&1; then
            echo "Credentials JSON is missing required service account fields."
            exit 1
          fi

          {
            echo "credentials_json<<EOF"
            printf '%s\n' "$CREDENTIALS_JSON"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ steps.gcp-creds.outputs.credentials_json }}
          project_id: ${{ steps.target-assets.outputs.project_id }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ steps.target-assets.outputs.project_id }}

      - name: Build public asset tree
        run: node scripts/copy-assets.mjs --sync-themes

      - name: Install ImageMagick
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Optimize image assets
        run: node scripts/optimize-public-images.mjs --require-tool

      - name: Upload assets to Firebase Storage
        id: upload-assets
        env:
          FIREBASE_PROJECT_ID: ${{ steps.target-assets.outputs.project_id }}
          FIREBASE_STORAGE_BUCKET: ${{ steps.target-assets.outputs.fb_storage_bucket }}
          ASSET_CACHE_CONTROL: ${{ vars.CDN_ASSET_CACHE_CONTROL || 'public,max-age=86400' }}
          CONTENT_CACHE_CONTROL: ${{ vars.CDN_CONTENT_CACHE_CONTROL || 'public,max-age=300,must-revalidate' }}
        run: |
          node scripts/upload-assets-to-firebase-storage.mjs \
            --bucket "$FIREBASE_STORAGE_BUCKET" \
            --asset-cache-control "$ASSET_CACHE_CONTROL" \
            --content-cache-control "$CONTENT_CACHE_CONTROL"

      - name: Smoke Test CDN Assets
        env:
          FIREBASE_PROJECT_ID: ${{ steps.target-assets.outputs.project_id }}
          CDN_VERIFY_RETRIES: ${{ vars.CDN_VERIFY_RETRIES || '8' }}
          CDN_VERIFY_DELAY_MS: ${{ vars.CDN_VERIFY_DELAY_MS || '3000' }}
          CDN_VERIFY_TIMEOUT_MS: ${{ vars.CDN_VERIFY_TIMEOUT_MS || '15000' }}
          CDN_REQUIRE_PUBLIC_READ: ${{ vars.CDN_REQUIRE_PUBLIC_READ || '0' }}
          CDN_AUTOCONFIGURE_PUBLIC_READ: ${{ vars.CDN_AUTOCONFIGURE_PUBLIC_READ || '0' }}
          CDN_AUTOCONFIGURE_CORS: ${{ vars.CDN_AUTOCONFIGURE_CORS || '1' }}
        run: |
          set -euo pipefail
          ASSET_BASE_URL="${CDN_RESOLVED_ASSET_BASE_URL:-}"
          if [ -z "${ASSET_BASE_URL:-}" ]; then
            echo "Missing CDN_RESOLVED_ASSET_BASE_URL for CDN smoke verification."
            exit 1
          fi
          normalize_flag() {
            printf '%s' "${1:-}" | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]'
          }
          CDN_REQUIRE_PUBLIC_READ_NORM="$(normalize_flag "${CDN_REQUIRE_PUBLIC_READ:-0}")"
          CDN_AUTOCONFIGURE_PUBLIC_READ_NORM="$(normalize_flag "${CDN_AUTOCONFIGURE_PUBLIC_READ:-0}")"
          CDN_AUTOCONFIGURE_CORS_NORM="$(normalize_flag "${CDN_AUTOCONFIGURE_CORS:-1}")"
          echo "CDN smoke flags: require_public_read='${CDN_REQUIRE_PUBLIC_READ:-}' (norm=${CDN_REQUIRE_PUBLIC_READ_NORM}), autoconfigure_public_read='${CDN_AUTOCONFIGURE_PUBLIC_READ:-}' (norm=${CDN_AUTOCONFIGURE_PUBLIC_READ_NORM})"
          BUCKET_NAME="${CDN_RESOLVED_BUCKET:-}"
          if [ -z "${BUCKET_NAME:-}" ]; then
            # Best-effort parse from storage.googleapis.com/<bucket>/...
            BUCKET_NAME="$(printf '%s' "$ASSET_BASE_URL" | sed -E 's#^https?://storage.googleapis.com/([^/]+)/.*#\1#')"
          fi
          if [ "${CDN_REQUIRE_PUBLIC_READ_NORM}" = "1" ] && [ "${CDN_AUTOCONFIGURE_PUBLIC_READ_NORM}" = "1" ]; then
            if [ -z "${BUCKET_NAME:-}" ]; then
              echo "Unable to determine bucket name for public IAM configuration."
              exit 1
            fi
            echo "Ensuring public object read IAM on gs://${BUCKET_NAME}"
            gcloud storage buckets add-iam-policy-binding "gs://${BUCKET_NAME}" \
              --member="allUsers" \
              --role="roles/storage.objectViewer" \
              --quiet
          fi
          if [ "${CDN_REQUIRE_PUBLIC_READ_NORM}" = "1" ] && [ "${CDN_AUTOCONFIGURE_CORS_NORM}" = "1" ]; then
            if [ -z "${BUCKET_NAME:-}" ]; then
              echo "Unable to determine bucket name for CORS configuration."
              exit 1
            fi
            if [ -z "${FIREBASE_PROJECT_ID:-}" ]; then
              echo "Missing FIREBASE_PROJECT_ID for CORS configuration."
              exit 1
            fi
            CORS_FILE="${RUNNER_TEMP}/cdn-cors.json"
            cat > "$CORS_FILE" <<EOF
          [
            {
              "origin": [
                "https://${FIREBASE_PROJECT_ID}.web.app",
                "https://${FIREBASE_PROJECT_ID}.firebaseapp.com",
                "http://localhost:5173",
                "http://127.0.0.1:5173"
              ],
              "method": ["GET", "HEAD", "OPTIONS"],
              "responseHeader": ["Content-Type", "Cache-Control", "ETag"],
              "maxAgeSeconds": 3600
            }
          ]
          EOF
            echo "Applying CORS policy to gs://${BUCKET_NAME}"
            gcloud storage buckets update "gs://${BUCKET_NAME}" --cors-file="$CORS_FILE"
          fi
          if [ "${ASSET_BASE_URL%/}" = "$ASSET_BASE_URL" ]; then
            ASSET_BASE_URL="${ASSET_BASE_URL}/"
          fi
          if [ "${CDN_REQUIRE_PUBLIC_READ_NORM}" = "1" ]; then
            CORS_HEADER="$(curl -sI \
              -H "Origin: https://${FIREBASE_PROJECT_ID}.web.app" \
              "${ASSET_BASE_URL}assets/themes/default/theme.config.json" \
              | tr -d '\r' \
              | awk -F': ' 'tolower($1)=="access-control-allow-origin"{print $2; exit}')"
            if [ -z "${CORS_HEADER:-}" ]; then
              echo "Missing Access-Control-Allow-Origin header on CDN asset response."
              echo "Verify bucket CORS policy allows origin https://${FIREBASE_PROJECT_ID}.web.app"
              exit 1
            fi
            echo "CDN CORS probe passed: access-control-allow-origin=${CORS_HEADER}"
            echo "CDN smoke verification mode: public-http"
            echo "CDN smoke verification base URL: ${ASSET_BASE_URL}"
            node scripts/check-cdn-assets.mjs \
              --retries "$CDN_VERIFY_RETRIES" \
              --delay-ms "$CDN_VERIFY_DELAY_MS" \
              --timeout-ms "$CDN_VERIFY_TIMEOUT_MS" \
              --url "${ASSET_BASE_URL}assets/themes/default/theme.config.json" \
              --url "${ASSET_BASE_URL}assets/logos/Biscuits_logo.png" \
              --url "${ASSET_BASE_URL}assets/music/game%20music.mp3" \
              --url "${ASSET_BASE_URL}rules.md" \
              --url "${ASSET_BASE_URL}updates.json"
          else
            echo "CDN smoke verification mode: private-bucket"
            if [ -z "${BUCKET_NAME:-}" ]; then
              echo "Missing bucket name for private CDN smoke verification."
              exit 1
            fi
            OBJECTS=(
              "assets/themes/default/theme.config.json"
              "assets/logos/Biscuits_logo.png"
              "assets/music/game music.mp3"
              "rules.md"
              "updates.json"
            )
            for object_path in "${OBJECTS[@]}"; do
              echo "Checking object exists: gs://${BUCKET_NAME}/${object_path}"
              gcloud storage objects describe "gs://${BUCKET_NAME}/${object_path}" \
                --format='value(name,size,contentType)' >/dev/null
            done
            echo "Private CDN verification passed."
          fi

      - name: CDN Access Diagnostics (on failure)
        if: ${{ failure() }}
        env:
          BUCKET_FALLBACK: ${{ steps.target-assets.outputs.fb_storage_bucket }}
        run: |
          set +e
          BUCKET_NAME="${CDN_RESOLVED_BUCKET:-${BUCKET_FALLBACK:-}}"
          echo "CDN diagnostics bucket: ${BUCKET_NAME:-<missing>}"
          if [ -z "${BUCKET_NAME:-}" ]; then
            echo "No bucket name available for diagnostics."
            exit 0
          fi
          echo "Bucket description:"
          gcloud storage buckets describe "gs://${BUCKET_NAME}" \
            --format='yaml(name,location,iamConfiguration.uniformBucketLevelAccess,iamConfiguration.publicAccessPrevention)'
          echo "Bucket IAM policy bindings:"
          gcloud storage buckets get-iam-policy "gs://${BUCKET_NAME}" \
            --format='yaml(bindings)'
          echo "Sample object metadata:"
          gcloud storage objects describe "gs://${BUCKET_NAME}/assets/themes/default/theme.config.json" \
            --format='yaml(name,size,contentType,cacheControl,metadata)'
          echo "HTTP HEAD probe:"
          curl -I "https://storage.googleapis.com/${BUCKET_NAME}/assets/themes/default/theme.config.json" || true
